-- CREATE OR REPLACE VIEW top_tags AS select row_number() OVER (order by count(*) DESC) as position, id_leyenda_tag, leyenda_tags.nombre, count(*) as popularidad from tags join leyenda_tags on id_leyenda_tag = leyenda_tags.id group by id_leyenda_tag, leyenda_tags.nombre order by popularidad DESC;
CREATE OR REPLACE VIEW top_tags AS select row_number() OVER (order by count(*) DESC) as position, id_taginfo, taginfo.name, count(*) as popularity from tags join taginfo on id_taginfo = taginfo.id group by id_taginfo, taginfo.name order by popularity DESC;
CREATE OR REPLACE view moods_general as select tabla_like.id_track, tabla_like.id_moods, tabla_like.nombre, tabla_like.votos_like, tabla_dislike.votos_dislike from (select id_moods,leyenda_mood.nombre, moods.id_track, count(vote) as votos_like from votos_moods join moods on moods.id = votos_moods.id_moods join leyenda_mood on leyenda_mood.id = moods.id_leyenda_mood group by id_moods, vote, moods.id_track, leyenda_mood.nombre having vote = 'like' order by votos_like DESC) as tabla_like join (select id_moods,leyenda_mood.nombre, moods.id_track, count(vote) as votos_dislike from votos_moods join moods on moods.id = votos_moods.id_moods join leyenda_mood on leyenda_mood.id = moods.id_leyenda_mood group by id_moods, vote, moods.id_track, leyenda_mood.nombre having vote = 'zero' order by votos_dislike DESC) as tabla_dislike on tabla_like.id_track = tabla_dislike.id_track;
CREATE or REPLACE view baby_tracks as select distinct(id_track), age(tracks.dumpdate) < INTERVAL '7 day' AS validada from votos_tag join tags on id_tags = id join tracks on tags.id_track = tracks.id group by votos_tag.id_tags, tags.id_track, validada having count(*) < 3;
GRANT SELECT ON top_tags, moods_general, baby_tracks to admin_moosic ;
GRANT INSERT ON top_tags, moods_general, baby_tracks to admin_moosic ;
GRANT DELETE ON top_tags, moods_general, baby_tracks to admin_moosic ;
GRANT UPDATE ON top_tags, moods_general, baby_tracks to admin_moosic ;
